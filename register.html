<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Cadastro — Palestra</title>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --brand:#E2231A; --brand-dark:#B51C15;
      --txt:#111827; --muted:#6b7280; --card:#ffffff; --bg:#f7f7f8; --stroke:#e5e7eb;
      --ok:#16a34a; --err:#dc2626; --radius:18px;
    }
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial;color:var(--txt);background:var(--bg)}
    .wrap{min-height:100%;display:grid;grid-template-rows:auto 1fr auto}
    header{background:var(--brand);color:#fff;padding:14px 18px}
    .head-inner{max-width:1080px;margin:0 auto;display:flex;align-items:center;gap:16px;justify-content:space-between}
    .brand{display:flex;align-items:center;gap:12px}.logo{width:120px;height:32px;object-fit:contain}
    .title{font-weight:700}.code-pill{background:#fff;color:var(--txt);border:1px solid #ffffff66;padding:8px 12px;border-radius:999px;font-weight:600;box-shadow:0 3px 10px rgba(0,0,0,.08)}
    main{max-width:1080px;margin:28px auto;padding:0 18px}
    .grid{display:grid;grid-template-columns:1.15fr .85fr;gap:20px}@media (max-width:940px){.grid{grid-template-columns:1fr}}
    .card{border:1px solid var(--stroke);background:var(--card);border-radius:var(--radius);padding:22px;box-shadow:0 8px 30px rgba(0,0,0,.06)}
    h2{margin:0 0 12px;font-size:22px}.muted{color:var(--muted)}
    .event{display:flex;align-items:center;gap:12px;margin:6px 0 14px}.dot{width:10px;height:10px;border-radius:50%;background:var(--brand)}
    form{display:grid;gap:14px;margin-top:10px}.field{display:grid;gap:8px}label{font-weight:600;font-size:13px;color:#374151}
    input,select{width:100%;padding:12px 14px;border-radius:12px;border:1px solid var(--stroke);background:#fff;color:var(--txt);outline:none;transition:border .15s,box-shadow .15s}
    input:focus,select:focus{border-color:var(--brand);box-shadow:0 0 0 3px rgba(226,35,26,.15)}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .btn{padding:12px 16px;border-radius:12px;cursor:pointer;border:0;background:var(--brand);color:#fff;font-weight:700;letter-spacing:.2px}
    .btn:hover{filter:brightness(1.05)} .btn:active{transform:translateY(1px)} .btn-ghost{background:#fff;color:var(--brand);border:1px solid var(--brand)}
    .qrbox{display:grid;place-items:center;gap:12px;padding:18px;border-radius:14px;border:1px dashed var(--stroke);background:#fafafa;min-height:320px}
    .status{margin-top:6px;font-size:14px}.ok{color:var(--ok)} .err{color:var(--err)}
    footer{padding:22px 18px;text-align:center;color:var(--muted);font-size:12px}
    .badge{padding:6px 10px;border:1px solid var(--stroke);border-radius:999px;color:#374151}
    .note{display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap;margin-top:12px}
    .home-tip{font-size:12px}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="head-inner">
        <div class="brand">
          <img src="logo.png" alt="Logo" class="logo" onerror="this.style.display='none'">
          <div class="title">Check-in de Palestra</div>
        </div>
        <div id="pill" class="code-pill">Código: —</div>
      </div>
    </header>

    <main>
      <div class="grid">
        <section class="card">
          <h2>Cadastro do Convidado</h2>
          <div class="event">
            <div class="dot"></div>
            <div>
              <div class="muted" id="eventTitle">Carregando…</div>
              <div class="muted" id="eventDate" style="font-size:12px"></div>
            </div>
          </div>

          <form id="form">
            <div class="field">
              <label for="nome">Nome completo</label>
              <input id="nome" autocomplete="name" placeholder="Ex.: Maria de Souza" required />
            </div>
            <div class="row">
              <div class="field">
                <label for="email">E-mail</label>
                <input id="email" type="email" autocomplete="email" placeholder="voce@email.com" required />
              </div>
              <div class="field">
                <label for="periodo">Período</label>
                <select id="periodo" required>
                  <option value="">Selecione…</option>
                  <option>Manhã</option>
                  <option>Tarde</option>
                  <option>Noite</option>
                </select>
              </div>
            </div>

            <div class="row">
              <button id="btnSubmit" class="btn" type="submit">Gerar QRCode</button>
              <button class="btn btn-ghost" type="button" id="btnLimpar">Limpar</button>
            </div>
            <div id="msg" class="status"></div>

            <div class="note">
              <span class="badge">Somente visual · sem salvar dados</span>
              <span class="home-tip">Use <code>?c=ABC123</code> na URL para definir o código.</span>
            </div>
          </form>
        </section>

        <section class="card">
          <h2>Seu QRCode</h2>
          <div id="qrbox" class="qrbox">
            <div class="muted" style="text-align:center">
              Gere o QR preenchendo o formulário ao lado.<br/>
              <small>O QR inclui: <b>email|codigo</b>.</small>
            </div>
          </div>
          <div class="row" style="margin-top:12px">
            <button class="btn" id="btnBaixar" type="button" disabled>Baixar imagem</button>
            <button class="btn btn-ghost" id="btnNovo" type="button" disabled>Novo QR</button>
          </div>
        </section>
      </div>
    </main>

    <footer>© Estudo Colgate — protótipo estático</footer>
  </div>

  <!-- libs -->
  <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
  <!-- opcional: seu integration.js; não é obrigatório aqui -->
  <!-- <script src="integration.js"></script> -->

  <script>
    // 🔗 URL da sua API (Apps Script) — COLE AQUI a URL /exec
    const API = "https://script.google.com/macros/s/AKfycbwffjumMygF1kzzbOiV3JwMnBLDjQN1tTwayUdEFXc3rpy6UyFBiccFsAt19W10g9mC1Q/exec";  // ex.: "https://script.google.com/macros/s/AKfycbx.../exec"

    // lê código da URL
    const qs = new URLSearchParams(location.search);
    const codigo = (qs.get('c') || '').trim();
    document.getElementById('pill').textContent = 'Código: ' + (codigo || '—');

    const form = document.getElementById('form');
    const msg = document.getElementById('msg');
    const qrbox = document.getElementById('qrbox');
    const btnBaixar = document.getElementById('btnBaixar');
    const btnNovo = document.getElementById('btnNovo');
    const btnLimpar = document.getElementById('btnLimpar');
    const btnSubmit = document.getElementById('btnSubmit');
    let lastPNG = null;

    // 🔸 integra com a planilha: busca palestra e preenche título/data
    async function carregarPalestra() {
      const titleEl = document.getElementById('eventTitle');
      const dateEl  = document.getElementById('eventDate');

      if (!codigo) {
        titleEl.textContent = 'Código não informado';
        dateEl.textContent = '';
        btnSubmit.disabled = true;
        msg.innerHTML = '<span class="err">Inclua ?c=CODIGO na URL.</span>';
        return;
      }

      try {
        const r = await fetch(`${API}?codigo=${encodeURIComponent(codigo)}`);
        const res = await r.json();

        if (!res.ok) {
          titleEl.textContent = 'Palestra não encontrada';
          dateEl.textContent = '';
          btnSubmit.disabled = true;
          msg.innerHTML = '<span class="err">Código inválido na planilha.</span>';
          return;
        }

        const p = res.palestra;
        titleEl.textContent = p.descricao || 'Palestra';
        dateEl.textContent  = p.dataBR ? `Data: ${p.dataBR}` : '';

        if (!p.ativo) {
          btnSubmit.disabled = true;
          msg.innerHTML = '<span class="err">Palestra inativa — geração de QR bloqueada.</span>';
        } else {
          btnSubmit.disabled = false;
          msg.innerHTML = '<span class="ok">Palestra ativa — você pode gerar o QR.</span>';
        }
      } catch (err) {
        console.error(err);
        titleEl.textContent = 'Erro ao consultar palestra';
        dateEl.textContent  = '';
        btnSubmit.disabled = true;
        msg.innerHTML = '<span class="err">Falha ao acessar a API.</span>';
      }
    }
    carregarPalestra();

    // geração do QR (mantido do seu template)
    form.addEventListener('submit', ev=>{
      ev.preventDefault();
      if (btnSubmit.disabled) return;

      qrbox.innerHTML = '';
      const email = document.getElementById('email').value.trim();
      const nome = document.getElementById('nome').value.trim();
      const periodo = document.getElementById('periodo').value;

      if(!email || !codigo){
        msg.innerHTML = '<span class="err">Preencha o e-mail e use um código válido.</span>';
        return;
      }

      const conteudo = `${email}|${codigo}`; // 🔐 padrão combinado
      const container = document.createElement('div');
      qrbox.appendChild(container);

      new QRCode(container, {
        text: conteudo,
        width: 250, height: 250,
        correctLevel: QRCode.CorrectLevel.M
      });

      // Captura imagem
      setTimeout(()=>{
        const img = container.querySelector('img');
        lastPNG = img ? img.src : null;
        btnBaixar.disabled = !lastPNG;
        btnNovo.disabled = false;
        msg.innerHTML = `<span class="ok">QR gerado: <b>${conteudo}</b></span>`;
      }, 150);
    });

    btnBaixar.onclick = ()=>{
      if(!lastPNG) return;
      const a = document.createElement('a');
      a.href = lastPNG;
      a.download = 'qrcode.png';
      a.click();
    };

    btnNovo.onclick = ()=>{
      qrbox.innerHTML = '<div class="muted" style="text-align:center">Preencha o formulário e gere seu QR.</div>';
      msg.textContent=''; btnBaixar.disabled=true; btnNovo.disabled=true;
    };

    btnLimpar.onclick = ()=>{ form.reset(); msg.textContent=''; document.getElementById('nome').focus(); };
  </script>
</body>
</html>
