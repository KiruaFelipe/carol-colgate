<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Leitor ‚Äî Palestra</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --brand:#E2231A; --brand-dark:#B51C15;
      --ok:#16a34a; --err:#dc2626;
      --bg:#f7f7f8; --txt:#111827; --muted:#6b7280;
      --card:#ffffff; --stroke:#e5e7eb; --radius:16px;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,system-ui;background:var(--bg);color:var(--txt)}
    header{
      background:var(--brand);color:#fff;padding:14px 20px;
      display:flex;justify-content:space-between;align-items:center
    }
    .code-pill{background:#fff;color:#111827;padding:6px 12px;border-radius:999px;font-weight:600}
    main{max-width:900px;margin:30px auto;padding:0 16px;display:grid;gap:20px}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:20px}
    @media(max-width:900px){.grid{grid-template-columns:1fr}}
    .card{background:var(--card);border:1px solid var(--stroke);border-radius:var(--radius);padding:20px;box-shadow:0 4px 18px #0001}
    h2{margin:0 0 10px}
    .btn{background:var(--brand);color:#fff;border:0;padding:10px 16px;border-radius:10px;font-weight:600;cursor:pointer}
    .btn:hover{filter:brightness(1.05)}
    .btn-ghost{background:#fff;color:var(--brand);border:1px solid var(--brand)}
    video{width:100%;border-radius:12px;background:#000}
    .status{margin-top:10px;font-size:14px}
    .ok{color:var(--ok)}
    .err{color:var(--err)}
    .kv{display:grid;grid-template-columns:120px 1fr;gap:8px}
    .kv div{padding:6px 8px;background:#f9fafb;border-radius:6px}
    .event{display:flex;align-items:center;gap:12px;margin:6px 0 10px}
    .event .dot{width:10px;height:10px;border-radius:50%;background:var(--brand)}
    .muted{color:var(--muted)}

    /* -------- Modal -------- */
    .backdrop{position:fixed; inset:0; background:rgba(0,0,0,.45); display:none; align-items:center; justify-content:center; padding:16px; z-index:50;}
    .backdrop.show{display:flex; animation:fadeIn .15s ease}
    @keyframes fadeIn{from{opacity:0}to{opacity:1}}
    .modal{width:min(520px, 96vw); background:#fff; color:var(--txt); border-radius:16px; border:1px solid var(--stroke);
      box-shadow:0 20px 60px rgba(0,0,0,.25); overflow:hidden; transform:translateY(6px); animation:pop .18s ease forwards;}
    @keyframes pop{to{transform:translateY(0)}}
    .modal-head{padding:14px 16px; background:#fff; border-bottom:1px solid var(--stroke); display:flex; align-items:center; justify-content:space-between; gap:8px;}
    .mh-title{font-weight:700}
    .modal-body{padding:16px}
    .modal-actions{padding:14px 16px; background:#fafafa; border-top:1px solid var(--stroke); display:flex; gap:10px; justify-content:flex-end;}
    .badge{padding:4px 8px; border-radius:999px; border:1px solid var(--stroke); color:#374151; font-size:12px;}
    .toast{position:fixed; bottom:18px; left:50%; transform:translateX(-50%); background:#0e9f6e; color:#fff; padding:10px 14px; border-radius:10px;
      box-shadow:0 10px 30px rgba(0,0,0,.25); font-weight:600; display:none; z-index:60;}
    .toast.show{display:block; animation:fadeIn .12s ease}
    .shake{animation:shake .25s}
    @keyframes shake{0%{transform:translateX(0)}25%{transform:translateX(-4px)}50%{transform:translateX(4px)}75%{transform:translateX(-3px)}100%{transform:translateX(0)}}
  </style>
</head>
<body>
  <header>
    <div><strong>Leitor QR ‚Äî Check-in</strong></div>
    <div id="pill" class="code-pill">C√≥digo: ‚Äî</div>
  </header>

  <main>
    <!-- Card com informa√ß√µes da palestra -->
    <section class="card" id="infoCard">
      <h2>Informa√ß√µes da palestra</h2>
      <div class="event">
        <div class="dot"></div>
        <div>
          <div id="eventTitle" class="muted">Carregando‚Ä¶</div>
          <div id="eventDate" class="muted" style="font-size:12px"></div>
        </div>
      </div>
    </section>

    <div class="grid">
      <!-- C√¢mera -->
      <section class="card" id="cameraCard">
        <h2>C√¢mera</h2>
        <p class="muted">Formato esperado do QR: <code>email|codigo</code>. O c√≥digo deve coincidir com este check-in.</p>
        <video id="video" playsinline></video>
        <div style="margin-top:10px;display:flex;gap:10px">
          <button id="start" class="btn">Iniciar</button>
          <button id="stop" class="btn-ghost" disabled>Parar</button>
        </div>
        <div id="status" class="status">Parado.</div>
      </section>

      <!-- Dados lidos -->
      <section class="card">
        <h2>Dados lidos</h2>
        <div class="kv">
          <strong>E-mail</strong><div id="outEmail">‚Äî</div>
          <strong>C√≥digo</strong><div id="outCodigo">‚Äî</div>
        </div>
        <p class="muted" style="margin-top:10px">
          Erros poss√≠veis:<br>
          ‚Ä¢ <b>Erro: QRCode Invalido</b> ‚Äî Situa√ß√£o: QrCode com o formato inv√°lido<br>
          ‚Ä¢ <b>Erro: QrCode Palestra nao encontrada</b> ‚Äî Situa√ß√£o: Est√° no formato correto por√©m com o c√≥digo errado
        </p>
      </section>
    </div>
  </main>

  <!-- Modal -->
  <div id="backdrop" class="backdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
      <div class="modal-head">
        <div class="mh-title" id="modalTitle">Confirmar presen√ßa</div>
        <span class="badge" id="modalBadge">Palestra: ‚Äî</span>
      </div>
      <div class="modal-body">
        <div style="display:grid; gap:10px">
          <div><strong>E-mail:</strong> <span id="mEmail">‚Äî</span></div>
          <div><strong>C√≥digo:</strong> <span id="mCodigo">‚Äî</span></div>
          <div><strong>Detectado em:</strong> <span id="mTs">‚Äî</span></div>
        </div>
        <div id="modalInfo" class="muted" style="margin-top:8px;"></div>
      </div>
      <div class="modal-actions">
        <button id="btnCancelar" class="btn-ghost">Cancelar</button>
        <button id="btnConfirmar" class="btn">Confirmar presen√ßa</button>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast" class="toast"></div>

  <!-- jsQR -->
  <script src="https://unpkg.com/jsqr/dist/jsQR.js"></script>
  <script>
  // üîó sua URL /exec
  const API = "https://script.google.com/macros/s/AKfycbwGbJWIfovlaegsXKKsBJpImPL5ABvIhbIGUPcRJcu1TlwmhSgKFWHCNXSibcKDSfNxog/exec";

  // C√≥digo da URL (?c=...)
  const qs = new URLSearchParams(location.search);
  const codigoUrl = (qs.get('c') || '').trim() || 'SEM-CODIGO';
  document.getElementById('pill').textContent = 'C√≥digo: ' + codigoUrl;

  const video=document.getElementById('video'), startBtn=document.getElementById('start'),
        stopBtn=document.getElementById('stop'), statusEl=document.getElementById('status');
  const outEmail=document.getElementById('outEmail'), outCodigo=document.getElementById('outCodigo');

  // Modal
  const backdrop = document.getElementById('backdrop');
  const mEmail = document.getElementById('mEmail');
  const mCodigo = document.getElementById('mCodigo');
  const mTs = document.getElementById('mTs');
  const modalBadge = document.getElementById('modalBadge');
  const btnCancelar = document.getElementById('btnCancelar');
  const btnConfirmar = document.getElementById('btnConfirmar');
  const modalInfo = document.getElementById('modalInfo');
  const toast = document.getElementById('toast');

  let stream=null, running=false, animId=null, lastPayload=null, modalOpen=false;
  const canvas=document.createElement('canvas'); const ctx=canvas.getContext('2d',{willReadFrequently:true});

  function showToast(txt, ok=true){
    toast.style.background = ok ? '#0e9f6e' : '#dc2626';
    toast.textContent = txt;
    toast.classList.add('show');
    setTimeout(()=>toast.classList.remove('show'), 2000);
  }
  function openModal(email, codigo){
    modalOpen = true;
    mEmail.textContent=email||'‚Äî'; mCodigo.textContent=codigo||'‚Äî';
    mTs.textContent=new Date().toLocaleString(); modalBadge.textContent='Palestra: '+(codigo||'‚Äî');
    modalInfo.textContent = '';
    backdrop.classList.add('show'); backdrop.setAttribute('aria-hidden','false');
  }
  function closeModal(){ modalOpen=false; backdrop.classList.remove('show'); backdrop.setAttribute('aria-hidden','true'); }

  // 1) Trazer informa√ß√µes da palestra
  (async () => {
    const titleEl = document.getElementById('eventTitle');
    const dateEl  = document.getElementById('eventDate');

    if (codigoUrl === 'SEM-CODIGO') {
      titleEl.textContent = 'C√≥digo n√£o informado';
      startBtn.disabled = true;
      statusEl.innerHTML = '<span class="err">Inclua ?c=CODIGO na URL.</span>';
      return;
    }
    try {
      const r = await fetch(`${API}?codigo=${encodeURIComponent(codigoUrl)}`);
      const res = await r.json();
      if (!res.ok) throw new Error('Palestra n√£o encontrada');
      if (!res.palestra.ativo) throw new Error('Palestra inativa');

      titleEl.textContent = res.palestra.descricao || 'Palestra';
      dateEl.textContent  = res.palestra.dataBR ? `Data: ${res.palestra.dataBR}` : '';
    } catch (e) {
      titleEl.textContent = '‚Äî';
      dateEl.textContent  = '';
      startBtn.disabled = true;
      statusEl.innerHTML = `<span class="err">${e.message}</span>`;
    }
  })();

  // 2) C√¢mera e leitura do QR
  async function startCam(){
    try{
      stream=await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'}});
      video.srcObject=stream; await video.play(); running=true;
      startBtn.disabled=true; stopBtn.disabled=false;
      statusEl.textContent='C√¢mera ativa‚Ä¶'; loop();
    }catch(e){statusEl.innerHTML='<span class="err">Erro ao abrir c√¢mera</span>';}
  }
  function stopCam(){
    running=false;if(animId)cancelAnimationFrame(animId);
    if(stream)stream.getTracks().forEach(t=>t.stop());
    startBtn.disabled=false;stopBtn.disabled=true;statusEl.textContent='Parado.';
  }

  function loop(){
    if(!running || modalOpen) { animId=requestAnimationFrame(loop); return; }
    if(video.readyState===video.HAVE_ENOUGH_DATA){
      canvas.width=video.videoWidth; canvas.height=video.videoHeight;
      ctx.drawImage(video,0,0,canvas.width,canvas.height);
      const img=ctx.getImageData(0,0,canvas.width,canvas.height);
      const qr=jsQR(img.data,img.width,img.height,{inversionAttempts:'dontInvert'});
      if(qr&&qr.data){
        const parts=(qr.data||'').trim().split('|');
        if(parts.length<2 || !parts[0] || !parts[1]){
          statusEl.innerHTML='<span class="err"><b>Erro: QRCode Invalido</b></span> ‚Äî <span class="muted">Situa√ß√£o: QrCode com o formato invalido</span>';
        }else{
          const email=parts[0]; const codigo=parts[1];
          outEmail.textContent=email; outCodigo.textContent=codigo;
          if(codigo!==codigoUrl){
            statusEl.innerHTML='<span class="err"><b>Erro: QrCode Palestra nao encontrada</b></span> ‚Äî <span class="muted">Situa√ß√£o: Est√° no formato correto porem com o codigo errado</span>';
          }else{
            const payload=`${email}|${codigo}`;
            if(payload!==lastPayload){
              lastPayload=payload; statusEl.innerHTML='<span class="ok">QR detectado</span>'; openModal(email,codigo);
            }
          }
        }
      }
    }
    animId=requestAnimationFrame(loop);
  }

  startBtn.onclick=startCam; stopBtn.onclick=stopCam;
  backdrop.addEventListener('click',(e)=>{ if(e.target===backdrop) closeModal(); });
  window.addEventListener('keydown',(e)=>{ if(e.key==='Escape') closeModal(); });

  // 3) Confirmar presen√ßa (POST action=presenca)
  btnConfirmar.addEventListener('click', async ()=>{
    btnConfirmar.disabled = true;
    modalInfo.textContent = 'Registrando presen√ßa‚Ä¶';
    try{
      const email = mEmail.textContent.trim();
      const body = new URLSearchParams({
        action:'presenca',
        codigoPalestra: codigoUrl,
        email
      }).toString();

      const resp = await fetch(API, {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body
      });
      const data = await resp.json();

      if (!data.ok) {
        modalInfo.innerHTML = `<span class="err">${data.error || 'Falha ao confirmar'}</span>`;
        showToast('Erro ao confirmar presen√ßa', false);
      } else if (data.status === 'ja_confirmada') {
        modalInfo.innerHTML = `<span class="ok">Presen√ßa j√° estava confirmada ‚úì</span>`;
        showToast('Presen√ßa j√° confirmada anteriormente ‚úì', true);
      } else {
        modalInfo.innerHTML = `<span class="ok">Presen√ßa confirmada ‚úì</span>`;
        showToast('Presen√ßa confirmada ‚úì', true);
      }
    } catch (e) {
      console.error(e);
      modalInfo.innerHTML = `<span class="err">Erro ao confirmar</span>`;
      showToast('Erro ao confirmar presen√ßa', false);
    } finally {
      btnConfirmar.disabled = false;
      // fecha o modal ap√≥s breve pausa
      setTimeout(closeModal, 700);
      // opcional: parar a c√¢mera ap√≥s confirmar
      // stopCam();
    }
  });

  btnCancelar.addEventListener('click', ()=> closeModal());
  </script>
</body>
</html>
