<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Leitor — Palestra</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{--brand:#E2231A;--ok:#16a34a;--err:#dc2626;--bg:#f7f7f8;--txt:#111827;--muted:#6b7280}
    body{margin:0;font-family:Inter,system-ui;background:var(--bg);color:var(--txt)}
    header{background:var(--brand);color:#fff;padding:14px 20px;display:flex;justify-content:space-between;align-items:center}
    .code-pill{background:#fff;color:var(--txt);padding:6px 12px;border-radius:999px;font-weight:600}
    main{max-width:800px;margin:30px auto;padding:0 16px;display:grid;gap:20px}
    .card{background:#fff;border:1px solid #e5e7eb;border-radius:16px;padding:20px;box-shadow:0 4px 18px #0001}
    .btn{background:var(--brand);color:#fff;border:0;padding:10px 16px;border-radius:10px;font-weight:600;cursor:pointer}
    .btn-ghost{background:#fff;color:var(--brand);border:1px solid var(--brand)}
    video{width:100%;border-radius:12px;background:#000}
    .kv{display:grid;grid-template-columns:120px 1fr;gap:8px}
    .kv div{padding:6px 8px;background:#f9fafb;border-radius:6px}
    .status{margin-top:10px;font-size:14px}.ok{color:var(--ok)}.err{color:var(--err)}
  </style>
</head>
<body>
  <header>
    <div><strong>Leitor QR — Check-in</strong></div>
    <div id="pill" class="code-pill">Código: —</div>
  </header>

  <main>
    <section class="card">
      <h2>Câmera</h2>
      <video id="video" playsinline></video>
      <div style="margin-top:10px;display:flex;gap:10px">
        <button id="start" class="btn">Iniciar</button>
        <button id="stop" class="btn-ghost" disabled>Parar</button>
      </div>
      <div id="status" class="status">Parado.</div>
    </section>

    <section class="card">
      <h2>Dados lidos</h2>
      <div class="kv">
        <strong>E-mail</strong><div id="outEmail">—</div>
        <strong>Código</strong><div id="outCodigo">—</div>
      </div>
    </section>
  </main>

  <footer style="text-align:center;color:var(--muted);font-size:12px;padding:10px">© Estudo Colgate</footer>

  <script src="https://unpkg.com/jsqr/dist/jsQR.js"></script>
  <script>
    // Código da URL (?c=...)
    const qs = new URLSearchParams(location.search);
    const codigoUrl = (qs.get('c') || '').trim() || 'SEM-CODIGO';
    document.getElementById('pill').textContent = 'Código: ' + codigoUrl;

    const video=document.getElementById('video'), startBtn=document.getElementById('start'),
          stopBtn=document.getElementById('stop'), statusEl=document.getElementById('status');
    const outEmail=document.getElementById('outEmail'), outCodigo=document.getElementById('outCodigo');
    let stream=null, running=false, animId=null;
    const canvas=document.createElement('canvas'); const ctx=canvas.getContext('2d',{willReadFrequently:true});

    async function startCam(){
      try{
        stream=await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'}});
        video.srcObject=stream; await video.play(); running=true;
        startBtn.disabled=true; stopBtn.disabled=false;
        statusEl.textContent='Câmera ativa...'; loop();
      }catch(e){statusEl.innerHTML='<span class="err">Erro ao abrir câmera</span>';console.error(e);}
    }
    function stopCam(){running=false;if(animId)cancelAnimationFrame(animId);if(stream)stream.getTracks().forEach(t=>t.stop());
      startBtn.disabled=false;stopBtn.disabled=true;statusEl.textContent='Parado.';}
    function loop(){
      if(!running)return;
      if(video.readyState===video.HAVE_ENOUGH_DATA){
        canvas.width=video.videoWidth; canvas.height=video.videoHeight;
        ctx.drawImage(video,0,0,canvas.width,canvas.height);
        const img=ctx.getImageData(0,0,canvas.width,canvas.height);
        const qr=jsQR(img.data,img.width,img.height,{inversionAttempts:'dontInvert'});
        if(qr&&qr.data){
          const dados=qr.data.split('|');
          outEmail.textContent=dados[0]||'—';
          outCodigo.textContent=dados[1]||'—';
          statusEl.innerHTML='<span class="ok">QR detectado</span>';
        }
      }
      animId=requestAnimationFrame(loop);
    }
    startBtn.onclick=startCam; stopBtn.onclick=stopCam;
  </script>
</body>
</html>
